name: Builds

on:
  push:
  pull_request:
    branches:
      - main

env:
  CTEST_OUTPUT_ON_FAILURE: 1
  
jobs:
  builds:
    name: ${{ matrix.platform.name }}-${{ matrix.build }}
    runs-on: ubuntu-latest
    container: ghcr.io/acts-project/ubuntu2004:v11
    strategy:
      matrix:
        platform:
          - name: CPU
            container: ghcr.io/acts-project/ubuntu2004:v11
          - name: CUDA
            container: ghcr.io/acts-project/ubuntu1804_cuda:v11
        build:
          - Release
          - Debug
    steps:
      - name: Dependencies
        run: apt-get install -y git-lfs
      - uses: actions/checkout@v2  
        with:
          submodules: true
          lfs: true
      - name: Configure
        run: |
          if ${{ matrix.platform.name == 'CPU'}}; then
            cmake -DCMAKE_BUILD_TYPE=${{ matrix.build }} -B build -S .	  
          elif ${{ matrix.platform.name == 'CUDA'}}; then
            cmake -DCMAKE_BUILD_TYPE=${{ matrix.build }} -DTRACCC_BUILD_CUDA=ON -B build -S .
          fi
      - name: Build
        run: cmake --build build -- -j$(nproc)
      - name: Run tests & examples
        run: CTEST_PARALLEL_LEVEL=$(nproc) cmake --build build -- test
          
